<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Jet Set Willy: Routine at 37841</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />

</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a class="link" href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="37819.html">37819</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#37841">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="37974.html">37974</a></span></td>
</tr>
</table>
<div class="description">37841: Draw the items in the current room and collect any that Willy is touching</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
Used by the routine at <a class="link" href="35245.html">35245</a>.
</div>
</div>
<table class="input-0">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>

</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="37841"></a>37841</td>
<td class="instruction">LD H,164</td>
<td class="comment-11" rowspan="1">Page <a class="link" href="41984.html">164</a> holds the first byte of each entry in the item table</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37843"></a>37843</td>
<td class="instruction">LD A,(41983)</td>
<td class="comment-11" rowspan="1">Pick up the index of the first item from <a class="link" href="41983.html">41983</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37846"></a>37846</td>
<td class="instruction">LD L,A</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at the first byte of the first entry in the item table</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="37847"></a>
<div class="comments">
<div class="paragraph">
The item-drawing loop begins here.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="37847"></a>37847</td>
<td class="instruction">LD C,(HL)</td>
<td class="comment-11" rowspan="1">Pick up the first byte of the current entry in the item table</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37848"></a>37848</td>
<td class="instruction">RES 7,C</td>
<td class="comment-11" rowspan="1">Reset bit 7; bit 6 holds the collection flag, and bits 0-5 hold the room number</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37850"></a>37850</td>
<td class="instruction">LD A,(33824)</td>
<td class="comment-11" rowspan="1">Pick up the number of the current room from <a class="link" href="33824.html">33824</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37853"></a>37853</td>
<td class="instruction">OR 64</td>
<td class="comment-11" rowspan="1">Set bit 6 (corresponding to the collection flag)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37855"></a>37855</td>
<td class="instruction">CP C</td>
<td class="comment-11" rowspan="1">Is the item in the current room and still uncollected?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37856"></a>37856</td>
<td class="instruction">JR NZ,<a class="link" href="37841.html#37970">37970</a></td>
<td class="comment-11" rowspan="1">If not, jump to consider the next entry in the item table</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="37858"></a>
<div class="comments">
<div class="paragraph">
This item is in the current room and has not been collected yet.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37858"></a>37858</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1">Pick up the first byte of the current entry in the item table</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37859"></a>37859</td>
<td class="instruction">RLCA</td>
<td class="comment-11" rowspan="7">Point <span class="register">DE</span> at the location of the item in the attribute buffer at <a class="link" href="23552.html">23552</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37860"></a>37860</td>
<td class="instruction">AND 1</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37862"></a>37862</td>
<td class="instruction">ADD A,92</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37864"></a>37864</td>
<td class="instruction">LD D,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37865"></a>37865</td>
<td class="instruction">INC H</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37866"></a>37866</td>
<td class="instruction">LD E,(HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37867"></a>37867</td>
<td class="instruction">DEC H</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37868"></a>37868</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-11" rowspan="1">Pick up the current attribute byte at the item's location</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37869"></a>37869</td>
<td class="instruction">AND 7</td>
<td class="comment-11" rowspan="2">Is the INK white (which happens if Willy is touching the item, or the room's background tile has white INK, as in <a class="link" href="57088.html">Swimming Pool</a>)?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37871"></a>37871</td>
<td class="instruction">CP 7</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37873"></a>37873</td>
<td class="instruction">JR NZ,<a class="link" href="37841.html#37936">37936</a></td>
<td class="comment-11" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="37875"></a>
<div class="comments">
<div class="paragraph">
Willy is touching this item (or the room's background tile has white INK), so add it to his collection.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37875"></a>37875</td>
<td class="instruction">LD IX,34172</td>
<td class="comment-11" rowspan="1">Point <span class="register">IX</span> at the number of items collected at <a class="link" href="34172.html">34172</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="37879"></a>37879</td>
<td class="instruction">INC (IX+2)</td>
<td class="comment-11" rowspan="1">Increment a digit of the number of items collected</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37882"></a>37882</td>
<td class="instruction">LD A,(IX+2)</td>
<td class="comment-11" rowspan="2">Was the digit originally '9'?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37885"></a>37885</td>
<td class="instruction">CP 58</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37887"></a>37887</td>
<td class="instruction">JR NZ,<a class="link" href="37841.html#37897">37897</a></td>
<td class="comment-11" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37889"></a>37889</td>
<td class="instruction">LD (IX+2),48</td>
<td class="comment-11" rowspan="1">Set the digit to '0'</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37893"></a>37893</td>
<td class="instruction">DEC IX</td>
<td class="comment-11" rowspan="1">Move back to the digit on the left</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37895"></a>37895</td>
<td class="instruction">JR <a class="link" href="37841.html#37879">37879</a></td>
<td class="comment-11" rowspan="1">Jump back to increment this digit</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="37897"></a>37897</td>
<td class="instruction">LD A,(32990)</td>
<td class="comment-11" rowspan="1">Pick up the border colour for the current room from <a class="link" href="32990.html">32990</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37900"></a>37900</td>
<td class="instruction">LD C,128</td>
<td class="comment-11" rowspan="12">Produce the sound effect for collecting an item</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="37902"></a>37902</td>
<td class="instruction">OUT (254),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37904"></a>37904</td>
<td class="instruction">XOR 24</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37906"></a>37906</td>
<td class="instruction">LD E,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37907"></a>37907</td>
<td class="instruction">LD A,144</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37909"></a>37909</td>
<td class="instruction">SUB C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37910"></a>37910</td>
<td class="instruction">LD B,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37911"></a>37911</td>
<td class="instruction">LD A,E</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="37912"></a>37912</td>
<td class="instruction">DJNZ <a class="link" href="37841.html#37912">37912</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37914"></a>37914</td>
<td class="instruction">DEC C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37915"></a>37915</td>
<td class="instruction">DEC C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37916"></a>37916</td>
<td class="instruction">JR NZ,<a class="link" href="37841.html#37902">37902</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37918"></a>37918</td>
<td class="instruction">LD A,(34270)</td>
<td class="comment-11" rowspan="3">Update the counter of items remaining at <a class="link" href="34270.html">34270</a>, and set the zero flag if there are no more items to collect</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37921"></a>37921</td>
<td class="instruction">INC A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37922"></a>37922</td>
<td class="instruction">LD (34270),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37925"></a>37925</td>
<td class="instruction">JR NZ,<a class="link" href="37841.html#37932">37932</a></td>
<td class="comment-11" rowspan="1">Jump if there are any items still to be collected</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37927"></a>37927</td>
<td class="instruction">LD A,1</td>
<td class="comment-11" rowspan="2">Update the game mode indicator at <a class="link" href="34271.html">34271</a> to 1 (all items collected)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37929"></a>37929</td>
<td class="instruction">LD (34271),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="37932"></a>37932</td>
<td class="instruction">RES 6,(HL)</td>
<td class="comment-11" rowspan="1">Reset bit 6 of the first byte of the entry in the item table: the item has been collected</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37934"></a>37934</td>
<td class="instruction">JR <a class="link" href="37841.html#37970">37970</a></td>
<td class="comment-11" rowspan="1">Jump to consider the next entry in the item table</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="37936"></a>
<div class="comments">
<div class="paragraph">
Willy is not touching this item, so draw it and cycle its INK colour.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="37936"></a>37936</td>
<td class="instruction">LD A,(34251)</td>
<td class="comment-11" rowspan="5">Generate the INK colour for the item from the value of the minute counter at <a class="link" href="34251.html">34251</a> (0-255) and the index of the item in the item table (173-255)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37939"></a>37939</td>
<td class="instruction">ADD A,L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37940"></a>37940</td>
<td class="instruction">AND 3</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37942"></a>37942</td>
<td class="instruction">ADD A,3</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37944"></a>37944</td>
<td class="instruction">LD C,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37945"></a>37945</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-11" rowspan="4">Change the INK colour of the item in the attribute buffer at <a class="link" href="23552.html">23552</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37946"></a>37946</td>
<td class="instruction">AND 248</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37948"></a>37948</td>
<td class="instruction">OR C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37949"></a>37949</td>
<td class="instruction">LD (DE),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37950"></a>37950</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="8">Point <span class="register">DE</span> at the location of the item in the screen buffer at <a class="link" href="24576.html">24576</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37951"></a>37951</td>
<td class="instruction">RLCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37952"></a>37952</td>
<td class="instruction">RLCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37953"></a>37953</td>
<td class="instruction">RLCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37954"></a>37954</td>
<td class="instruction">RLCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37955"></a>37955</td>
<td class="instruction">AND 8</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37957"></a>37957</td>
<td class="instruction">ADD A,96</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37959"></a>37959</td>
<td class="instruction">LD D,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37960"></a>37960</td>
<td class="instruction">PUSH HL</td>
<td class="comment-11" rowspan="1">Save <span class="register">HL</span> briefly</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37961"></a>37961</td>
<td class="instruction">LD HL,32993</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at the item graphic for the current room (at <a class="link" href="32993.html">32993</a>)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37964"></a>37964</td>
<td class="instruction">LD B,8</td>
<td class="comment-11" rowspan="1">There are eight pixel rows to copy</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37966"></a>37966</td>
<td class="instruction">CALL <a class="link" href="38545.html#38555">38555</a></td>
<td class="comment-11" rowspan="1">Draw the item to the screen buffer at <a class="link" href="24576.html">24576</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37969"></a>37969</td>
<td class="instruction">POP HL</td>
<td class="comment-11" rowspan="1">Restore the item table pointer to <span class="register">HL</span></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="37970"></a>
<div class="comments">
<div class="paragraph">
The current item has been dealt with (skipped, collected or drawn) as appropriate. Time to consider the next one.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="37970"></a>37970</td>
<td class="instruction">INC L</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at the first byte of the next entry in the item table</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37971"></a>37971</td>
<td class="instruction">JR NZ,<a class="link" href="37841.html#37847">37847</a></td>
<td class="comment-11" rowspan="1">Jump back unless we've examined every entry</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37973"></a>37973</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="37819.html">37819</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#37841">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="37974.html">37974</a></span></td>
</tr>
</table>
<div class="footer">
<div class="release">The complete Jet Set Willy RAM disassembly 20141114</div>
<div class="copyright">&#169; 1984 Software Projects Ltd (Jet Set Willy). &#169; 2014 Richard Dymond (this disassembly).</div>
<div class="created">Created using <a class="link" href="http://skoolkit.ca/">SkoolKit</a> 4.1.1.</div>
</div>
</body>
</html>