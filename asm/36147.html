<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Jet Set Willy: Routine at 36147</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />

</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a class="link" href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="35914.html">35914</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#36147">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="36203.html">36203</a></span></td>
</tr>
</table>
<div class="description">36147: Draw the current room to the screen buffer at 28672</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
Used by the routine at <a class="link" href="35068.html">35068</a>.
</div>
</div>
<table class="input-0">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>

</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="36147"></a>36147</td>
<td class="instruction">CALL <a class="link" href="36203.html">36203</a></td>
<td class="comment-11" rowspan="1">Fill the buffer at <a class="link" href="24064.html">24064</a> with attribute bytes for the current room</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="36150"></a>36150</td>
<td class="instruction">LD IX,24064</td>
<td class="comment-11" rowspan="1">Point <span class="register">IX</span> at the first byte of the attribute buffer at <a class="link" href="24064.html">24064</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="36154"></a>36154</td>
<td class="instruction">LD A,112</td>
<td class="comment-11" rowspan="2">Set the operand of the 'LD D,n' instruction at <a class="link" href="36147.html#36188">36188</a> (below) to 112</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="36156"></a>36156</td>
<td class="instruction">LD (36189),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="36159"></a>36159</td>
<td class="instruction">CALL <a class="link" href="36147.html#36171">36171</a></td>
<td class="comment-11" rowspan="1">Draw the tiles for the top half of the room to the screen buffer at <a class="link" href="28672.html">28672</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="36162"></a>36162</td>
<td class="instruction">LD IX,24320</td>
<td class="comment-11" rowspan="1">Point <span class="register">IX</span> at the 256th byte of the attribute buffer at <a class="link" href="24064.html">24064</a> in preparation for drawing the bottom half of the room; this instruction is redundant, since <span class="register">IX</span> already holds 24320</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="36166"></a>36166</td>
<td class="instruction">LD A,120</td>
<td class="comment-11" rowspan="2">Set the operand of the 'LD D,n' instruction at <a class="link" href="36147.html#36188">36188</a> (below) to 120</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="36168"></a>36168</td>
<td class="instruction">LD (36189),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="36171"></a>36171</td>
<td class="instruction">LD C,0</td>
<td class="comment-11" rowspan="1"><span class="register">C</span> will count 256 tiles</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="36173"></a>
<div class="comments">
<div class="paragraph">
The following loop draws 256 tiles (for either the top half or the bottom half of the room) to the screen buffer at <a class="link" href="28672.html">28672</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="36173"></a>36173</td>
<td class="instruction">LD E,C</td>
<td class="comment-11" rowspan="1"><span class="register">E</span> holds the LSB of the screen buffer address</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="36174"></a>36174</td>
<td class="instruction">LD A,(IX+0)</td>
<td class="comment-11" rowspan="1">Pick up an attribute byte from the buffer at <a class="link" href="24064.html">24064</a>; this identifies the type of tile (background, floor, wall, nasty, ramp or conveyor) to be drawn</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="36177"></a>36177</td>
<td class="instruction">LD HL,32928</td>
<td class="comment-11" rowspan="3">Move <span class="register">HL</span> through the attribute bytes and graphic data of the background, floor, wall, nasty, ramp and conveyor tiles starting at <a class="link" href="32768.html#32928">32928</a> until we find a byte that matches the attribute byte of the tile to be drawn; note that if a graphic data byte matches the attribute byte being searched for, the CPIR instruction can exit early, which is a <a class="link" href="../reference/bugs.html#corruptedConveyors">bug</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="36180"></a>36180</td>
<td class="instruction">LD BC,54</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="36183"></a>36183</td>
<td class="instruction">CPIR</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="36185"></a>36185</td>
<td class="instruction">LD C,E</td>
<td class="comment-11" rowspan="1">Restore the value of the tile counter in <span class="register">C</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="36186"></a>36186</td>
<td class="instruction">LD B,8</td>
<td class="comment-11" rowspan="1">There are eight bytes in the tile</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="36188"></a>36188</td>
<td class="instruction">LD D,0</td>
<td class="comment-11" rowspan="1">This instruction is set to either 'LD D,112' or 'LD D,120' above; now <span class="register">DE</span> holds the appropriate address in the screen buffer at <a class="link" href="28672.html">28672</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="36190"></a>36190</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="5">Copy the tile graphic data to the screen buffer at <a class="link" href="28672.html">28672</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="36191"></a>36191</td>
<td class="instruction">LD (DE),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="36192"></a>36192</td>
<td class="instruction">INC HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="36193"></a>36193</td>
<td class="instruction">INC D</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="36194"></a>36194</td>
<td class="instruction">DJNZ <a class="link" href="36147.html#36190">36190</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="36196"></a>36196</td>
<td class="instruction">INC IX</td>
<td class="comment-11" rowspan="1">Move <span class="register">IX</span> along to the next byte in the attribute buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="36198"></a>36198</td>
<td class="instruction">INC C</td>
<td class="comment-11" rowspan="1">Have we drawn 256 tiles yet?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="36199"></a>36199</td>
<td class="instruction">JP NZ,<a class="link" href="36147.html#36173">36173</a></td>
<td class="comment-11" rowspan="1">If not, jump back to draw the next one</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="36202"></a>36202</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="35914.html">35914</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#36147">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="36203.html">36203</a></span></td>
</tr>
</table>
<div class="footer">
<div class="release">The complete Jet Set Willy RAM disassembly 20140913</div>
<div class="copyright">&#169; 1984 Software Projects Ltd (Jet Set Willy). &#169; 2014 Richard Dymond (this disassembly).</div>
<div class="created">Created using <a class="link" href="http://pyskool.ca/?page_id=177">SkoolKit</a> 4.1.</div>
</div>
</body>
</html>