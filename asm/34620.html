<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Jet Set Willy: Routine at 34620</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />

</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a class="link" href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="34499.html">34499</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#34620">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="34762.html">34762</a></span></td>
</tr>
</table>
<div class="description">34620: Read the keyboard during code entry</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
Used by the routine at <a class="link" href="34499.html">34499</a>. Waits for '1', '2', '3', '4' or ENTER to be pressed and either prints a coloured block or validates the entered code. Returns to the routine at <a class="link" href="34463.html">34463</a> if ENTER is being pressed, with the zero flag reset if the entered code is correct.
</div>
</div>
<table class="input-1">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">IX</td>
<td class="register-desc">Attribute file address of the flashing 2x2 block</td>
</tr>
</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="34620"></a>34620</td>
<td class="instruction">LD BC,63486</td>
<td class="comment-11" rowspan="2">Read keys 1-2-3-4-5</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="34623"></a>34623</td>
<td class="instruction">IN A,(C)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="34625"></a>34625</td>
<td class="instruction">AND 15</td>
<td class="comment-11" rowspan="2">Is '1', '2', '3' or '4' (still) being pressed?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="34627"></a>34627</td>
<td class="instruction">CP 15</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="34629"></a>34629</td>
<td class="instruction">JR NZ,<a class="link" href="34620.html#34620">34620</a></td>
<td class="comment-11" rowspan="1">Jump back if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="34631"></a>34631</td>
<td class="instruction">LD B,191</td>
<td class="comment-11" rowspan="2">Read keys H-J-K-L-ENTER</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="34633"></a>34633</td>
<td class="instruction">IN A,(C)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="34635"></a>34635</td>
<td class="instruction">BIT 0,A</td>
<td class="comment-11" rowspan="1">Is ENTER being pressed?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="34637"></a>34637</td>
<td class="instruction">JR NZ,<a class="link" href="34620.html#34693">34693</a></td>
<td class="comment-11" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="34639"></a>34639</td>
<td class="instruction">LD A,(22873)</td>
<td class="comment-11" rowspan="1">Pick up the attribute byte of the fourth 2x2 block at (10,25)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="34642"></a>34642</td>
<td class="instruction">AND 127</td>
<td class="comment-11" rowspan="2">Has the fourth digit been entered yet?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="34644"></a>34644</td>
<td class="instruction">CP 7</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="34646"></a>34646</td>
<td class="instruction">JR Z,<a class="link" href="34620.html#34693">34693</a></td>
<td class="comment-11" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="34648"></a>
<div class="comments">
<div class="paragraph">
We have four coloured blocks, and ENTER is being pressed. Time to validate the entered code.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="34648"></a>34648</td>
<td class="instruction">SUB 8</td>
<td class="comment-11" rowspan="6">Compute bits 0 and 1 of the entered code from the attribute byte of the fourth coloured block at (10,25) and store them in <span class="register">C</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="34650"></a>34650</td>
<td class="instruction">AND 24</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="34652"></a>34652</td>
<td class="instruction">RRCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="34653"></a>34653</td>
<td class="instruction">RRCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="34654"></a>34654</td>
<td class="instruction">RRCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="34655"></a>34655</td>
<td class="instruction">LD C,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="34656"></a>34656</td>
<td class="instruction">LD A,(22867)</td>
<td class="comment-11" rowspan="6">Compute bits 4 and 5 of the entered code from the attribute byte of the second coloured block at (10,19) and store them in <span class="register">C</span> (alongside bits 0 and 1)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="34659"></a>34659</td>
<td class="instruction">SUB 8</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="34661"></a>34661</td>
<td class="instruction">AND 24</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="34663"></a>34663</td>
<td class="instruction">RLCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="34664"></a>34664</td>
<td class="instruction">OR C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="34665"></a>34665</td>
<td class="instruction">LD C,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="34666"></a>34666</td>
<td class="instruction">LD A,(22870)</td>
<td class="comment-11" rowspan="6">Compute bits 2 and 3 of the entered code from the attribute byte of the third coloured block at (10,22) and store them in <span class="register">C</span> (alongside bits 0, 1, 4 and 5)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="34669"></a>34669</td>
<td class="instruction">SUB 8</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="34671"></a>34671</td>
<td class="instruction">AND 24</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="34673"></a>34673</td>
<td class="instruction">RRCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="34674"></a>34674</td>
<td class="instruction">OR C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="34675"></a>34675</td>
<td class="instruction">LD C,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="34676"></a>34676</td>
<td class="instruction">LD A,(22864)</td>
<td class="comment-11" rowspan="6">Compute bits 6 and 7 of the entered code from the attribute byte of the first coloured block at (10,16) in <span class="register">A</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="34679"></a>34679</td>
<td class="instruction">SUB 8</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="34681"></a>34681</td>
<td class="instruction">AND 24</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="34683"></a>34683</td>
<td class="instruction">RLCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="34684"></a>34684</td>
<td class="instruction">RLCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="34685"></a>34685</td>
<td class="instruction">RLCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="34686"></a>34686</td>
<td class="instruction">POP HL</td>
<td class="comment-11" rowspan="1">Drop the return address from the stack</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="34687"></a>34687</td>
<td class="instruction">OR C</td>
<td class="comment-11" rowspan="1">Merge bits 0-5 of the entered code into <span class="register">A</span>; now <span class="register">A</span> holds all 8 bits of the entered code</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="34688"></a>34688</td>
<td class="instruction">LD HL,34276</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at <a class="link" href="34276.html">34276</a> (where the correct entry code is stored)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="34691"></a>34691</td>
<td class="instruction">CP (HL)</td>
<td class="comment-11" rowspan="1">Set the zero flag if the entered code matches</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="34692"></a>34692</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1">Return to the routine at <a class="link" href="34463.html">34463</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="34693"></a>
<div class="comments">
<div class="paragraph">
Here we check whether '1', '2', '3' or '4' is being pressed.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="34693"></a>34693</td>
<td class="instruction">SET 7,(IX+0)</td>
<td class="comment-11" rowspan="4">Make sure the current 2x2 block is flashing</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="34697"></a>34697</td>
<td class="instruction">SET 7,(IX+1)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="34701"></a>34701</td>
<td class="instruction">SET 7,(IX+32)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="34705"></a>34705</td>
<td class="instruction">SET 7,(IX+33)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="34709"></a>34709</td>
<td class="instruction">LD BC,63486</td>
<td class="comment-11" rowspan="2">Read keys 1-2-3-4-5</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="34712"></a>34712</td>
<td class="instruction">IN A,(C)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="34714"></a>34714</td>
<td class="instruction">AND 15</td>
<td class="comment-11" rowspan="1">Keep only bits 0-3 (keys 1-2-3-4)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="34716"></a>34716</td>
<td class="instruction">LD E,8</td>
<td class="comment-11" rowspan="1"><span class="register">E</span>=8 (INK 0: PAPER 1)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="34718"></a>34718</td>
<td class="instruction">CP 14</td>
<td class="comment-11" rowspan="1">Is '1' alone being pressed?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="34720"></a>34720</td>
<td class="instruction">JR Z,<a class="link" href="34620.html#34741">34741</a></td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="34722"></a>34722</td>
<td class="instruction">LD E,16</td>
<td class="comment-11" rowspan="1"><span class="register">E</span>=16 (INK 0: PAPER 2)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="34724"></a>34724</td>
<td class="instruction">CP 13</td>
<td class="comment-11" rowspan="1">Is '2' alone being pressed?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="34726"></a>34726</td>
<td class="instruction">JR Z,<a class="link" href="34620.html#34741">34741</a></td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="34728"></a>34728</td>
<td class="instruction">LD E,24</td>
<td class="comment-11" rowspan="1"><span class="register">E</span>=24 (INK 0: PAPER 3)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="34730"></a>34730</td>
<td class="instruction">CP 11</td>
<td class="comment-11" rowspan="1">Is '3' alone being pressed?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="34732"></a>34732</td>
<td class="instruction">JR Z,<a class="link" href="34620.html#34741">34741</a></td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="34734"></a>34734</td>
<td class="instruction">LD E,32</td>
<td class="comment-11" rowspan="1"><span class="register">E</span>=32 (INK 0: PAPER 4)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="34736"></a>34736</td>
<td class="instruction">CP 7</td>
<td class="comment-11" rowspan="1">Is '4' alone being pressed?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="34738"></a>34738</td>
<td class="instruction">JP NZ,<a class="link" href="34620.html#34631">34631</a></td>
<td class="comment-11" rowspan="1">If not, jump back to check the ENTER key</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="34741"></a>
<div class="comments">
<div class="paragraph">
Exactly one of the number keys '1', '2', '3' or '4' is being pressed. <span class="register">E</span> holds the corresponding attribute byte to use for the coloured block.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="34741"></a>34741</td>
<td class="instruction">LD (IX+0),E</td>
<td class="comment-11" rowspan="4">Set the colour of the 2x2 block (no longer flashing)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="34744"></a>34744</td>
<td class="instruction">LD (IX+1),E</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="34747"></a>34747</td>
<td class="instruction">LD (IX+32),E</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="34750"></a>34750</td>
<td class="instruction">LD (IX+33),E</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="34753"></a>34753</td>
<td class="instruction">LD BC,24</td>
<td class="comment-11" rowspan="4">Pause for about 0.02s</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="34756"></a>34756</td>
<td class="instruction">DJNZ <a class="link" href="34620.html#34756">34756</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="34758"></a>34758</td>
<td class="instruction">DEC C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="34759"></a>34759</td>
<td class="instruction">JR NZ,<a class="link" href="34620.html#34756">34756</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="34761"></a>34761</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="34499.html">34499</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#34620">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="34762.html">34762</a></span></td>
</tr>
</table>
<div class="footer">
<div class="release">The complete Jet Set Willy RAM disassembly 20140913</div>
<div class="copyright">&#169; 1984 Software Projects Ltd (Jet Set Willy). &#169; 2014 Richard Dymond (this disassembly).</div>
<div class="created">Created using <a class="link" href="http://pyskool.ca/?page_id=177">SkoolKit</a> 4.1.</div>
</div>
</body>
</html>