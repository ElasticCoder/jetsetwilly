<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Jet Set Willy: Routine at 37974</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />

</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a class="link" href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="37841.html">37841</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#37974">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="38026.html">38026</a></span></td>
</tr>
</table>
<div class="description">37974: Draw a sprite</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
Used by the routines at <a class="link" href="34499.html">34499</a> (to draw the number key graphics on the code entry screen), <a class="link" href="35211.html">35211</a> (to draw the remaining lives), <a class="link" href="35914.html">35914</a> (to draw Willy, the foot and the barrel during the game over sequence), <a class="link" href="37310.html">37310</a> (to draw guardians in the current room) and <a class="link" href="38196.html">38196</a> (to draw Maria in <a class="link" href="58112.html">Master Bedroom</a>). If <span class="register">C</span>=1 on entry, this routine returns with the zero flag reset if any of the set bits in the sprite being drawn collides with a set bit in the background.
</div>
</div>
<table class="input-1">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">C</td>
<td class="register-desc">Drawing mode: 0 (overwrite) or 1 (blend)</td>
</tr>
<tr>
<td class="register">DE</td>
<td class="register-desc">Address of sprite graphic data</td>
</tr>
<tr>
<td class="register">HL</td>
<td class="register-desc">Address to draw at</td>
</tr>
</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="37974"></a>37974</td>
<td class="instruction">LD B,16</td>
<td class="comment-11" rowspan="1">There are 16 rows of pixels to draw</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="37976"></a>37976</td>
<td class="instruction">BIT 0,C</td>
<td class="comment-11" rowspan="1">Set the zero flag if we're in overwrite mode</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37978"></a>37978</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-11" rowspan="1">Pick up a sprite graphic byte</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37979"></a>37979</td>
<td class="instruction">JR Z,<a class="link" href="37974.html#37985">37985</a></td>
<td class="comment-11" rowspan="1">Jump if we're in overwrite mode</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37981"></a>37981</td>
<td class="instruction">AND (HL)</td>
<td class="comment-11" rowspan="2">Return with the zero flag reset if any of the set bits in the sprite graphic byte collide with a set bit in the background (e.g. in Willy's sprite)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37982"></a>37982</td>
<td class="instruction">RET NZ</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37983"></a>37983</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-11" rowspan="1">Pick up the sprite graphic byte again</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37984"></a>37984</td>
<td class="instruction">OR (HL)</td>
<td class="comment-11" rowspan="1">Blend it with the background byte</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="37985"></a>37985</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-11" rowspan="1">Copy the graphic byte to its destination cell</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37986"></a>37986</td>
<td class="instruction">INC L</td>
<td class="comment-11" rowspan="1">Move <span class="register">HL</span> along to the next cell on the right</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37987"></a>37987</td>
<td class="instruction">INC DE</td>
<td class="comment-11" rowspan="1">Point <span class="register">DE</span> at the next sprite graphic byte</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37988"></a>37988</td>
<td class="instruction">BIT 0,C</td>
<td class="comment-11" rowspan="1">Set the zero flag if we're in overwrite mode</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37990"></a>37990</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-11" rowspan="1">Pick up a sprite graphic byte</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37991"></a>37991</td>
<td class="instruction">JR Z,<a class="link" href="37974.html#37997">37997</a></td>
<td class="comment-11" rowspan="1">Jump if we're in overwrite mode</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37993"></a>37993</td>
<td class="instruction">AND (HL)</td>
<td class="comment-11" rowspan="2">Return with the zero flag reset if any of the set bits in the sprite graphic byte collide with a set bit in the background (e.g. in Willy's sprite)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37994"></a>37994</td>
<td class="instruction">RET NZ</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37995"></a>37995</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-11" rowspan="1">Pick up the sprite graphic byte again</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37996"></a>37996</td>
<td class="instruction">OR (HL)</td>
<td class="comment-11" rowspan="1">Blend it with the background byte</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="37997"></a>37997</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-11" rowspan="1">Copy the graphic byte to its destination cell</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37998"></a>37998</td>
<td class="instruction">DEC L</td>
<td class="comment-11" rowspan="2">Move <span class="register">HL</span> to the next pixel row down in the cell on the left</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37999"></a>37999</td>
<td class="instruction">INC H</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="38000"></a>38000</td>
<td class="instruction">INC DE</td>
<td class="comment-11" rowspan="1">Point <span class="register">DE</span> at the next sprite graphic byte</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="38001"></a>38001</td>
<td class="instruction">LD A,H</td>
<td class="comment-11" rowspan="2">Have we drawn the bottom pixel row in this pair of cells yet?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="38002"></a>38002</td>
<td class="instruction">AND 7</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="38004"></a>38004</td>
<td class="instruction">JR NZ,<a class="link" href="37974.html#38022">38022</a></td>
<td class="comment-11" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="38006"></a>38006</td>
<td class="instruction">LD A,H</td>
<td class="comment-11" rowspan="6">Otherwise move <span class="register">HL</span> to the top pixel row in the cell below</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="38007"></a>38007</td>
<td class="instruction">SUB 8</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="38009"></a>38009</td>
<td class="instruction">LD H,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="38010"></a>38010</td>
<td class="instruction">LD A,L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="38011"></a>38011</td>
<td class="instruction">ADD A,32</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="38013"></a>38013</td>
<td class="instruction">LD L,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="38014"></a>38014</td>
<td class="instruction">AND 224</td>
<td class="comment-11" rowspan="1">Was the last pair of cells at y-coordinate 7 or 15?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="38016"></a>38016</td>
<td class="instruction">JR NZ,<a class="link" href="37974.html#38022">38022</a></td>
<td class="comment-11" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="38018"></a>38018</td>
<td class="instruction">LD A,H</td>
<td class="comment-11" rowspan="3">Otherwise adjust <span class="register">HL</span> to account for the movement from the top or middle third of the screen to the next one down</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="38019"></a>38019</td>
<td class="instruction">ADD A,8</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="38021"></a>38021</td>
<td class="instruction">LD H,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="38022"></a>38022</td>
<td class="instruction">DJNZ <a class="link" href="37974.html#37976">37976</a></td>
<td class="comment-11" rowspan="1">Jump back until all 16 rows of pixels have been drawn</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="38024"></a>38024</td>
<td class="instruction">XOR A</td>
<td class="comment-11" rowspan="1">Set the zero flag (to indicate no collision)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="38025"></a>38025</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="37841.html">37841</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#37974">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="38026.html">38026</a></span></td>
</tr>
</table>
<div class="footer">
<div class="release">The complete Jet Set Willy RAM disassembly 20141114</div>
<div class="copyright">&#169; 1984 Software Projects Ltd (Jet Set Willy). &#169; 2014 Richard Dymond (this disassembly).</div>
<div class="created">Created using <a class="link" href="http://skoolkit.ca/">SkoolKit</a> 4.1.1.</div>
</div>
</body>
</html>